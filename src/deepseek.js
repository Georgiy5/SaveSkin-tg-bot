import axios from "axios"

// –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–∫–æ—Ä–æ—á–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∞–ª–æ—Å—å –º–µ—Å—Ç–æ –¥–ª—è –æ—Ç–≤–µ—Ç–∞)
const getSystemPrompt = (typeOf, features) => `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ—Å–º–µ—Ç–æ–ª–æ–≥-–¥–µ—Ä–º–∞—Ç–æ–ª–æ–≥. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ—Å—Ç–∞–≤ –∫–æ—Å–º–µ—Ç–∏–∫–∏.

## –î–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
- –¢–∏–ø –∫–æ–∂–∏: ${typeOf}
- –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: ${features}

## –ö–†–ê–¢–ö–ò–ô –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–º–∞–∫—Å–∏–º—É–º 3500 —Å–∏–º–≤–æ–ª–æ–≤):

–ö–û–°–ú–ï–¢–ò–ß–ï–°–ö–û–ï –°–†–ï–î–°–¢–í–û: [–ù–∞–∑–≤–∞–Ω–∏–µ]

üìä –û–ë–©–ê–Ø –û–¶–ï–ù–ö–ê: X/10
‚ö†Ô∏è –û–°–ù–û–í–ù–´–ï –†–ò–°–ö–ò: [2-3 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö —Ä–∏—Å–∫–∞]

üî¥ –í–´–°–û–ö–û–†–ò–°–ö–û–í–ê–ù–ù–´–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´:
‚Ä¢ [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç 1] - –∫–∞–º–µ–¥–æ–≥–µ–Ω–Ω–æ—Å—Ç—å X/5, –∞–ª–ª–µ—Ä–≥–µ–Ω–Ω–æ—Å—Ç—å: [–≤—ã—Å–æ–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/–Ω–∏–∑–∫–∞—è]
‚Ä¢ [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç 2] - [–∫—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ]

üü° –£–ú–ï–†–ï–ù–ù–û –†–ò–°–ö–û–í–ê–ù–ù–´–ï:
‚Ä¢ [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç] - [–ø–æ—á–µ–º—É –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ]

üü¢ –ë–ï–ó–û–ü–ê–°–ù–´–ï/–ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´:
‚Ä¢ [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç] - [–ø–æ–ª—å–∑–∞]

üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø ${typeOf} –ö–û–ñ–ò:
1. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1]
2. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2]
3. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 3]

üß™ –ü–∞—Ç—á-—Ç–µ—Å—Ç: –ù–∞–Ω–µ—Å–∏—Ç–µ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —á–∞—Å—Ç—å –ø—Ä–µ–¥–ø–ª–µ—á—å—è –Ω–∞ 24-48 —á–∞—Å–æ–≤.

üìå –í–ï–†–î–ò–ö–¢: [–ü–æ–¥—Ö–æ–¥–∏—Ç/–ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç/–ü–æ–¥—Ö–æ–¥–∏—Ç —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é]

## –ü–†–ê–í–ò–õ–ê –ê–ù–ê–õ–ò–ó–ê:
1. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–µ—Ä–≤—ã–µ 10 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –æ—Å–æ–±–µ–Ω–Ω–æ —Ç—â–∞—Ç–µ–ª—å–Ω–æ (–Ω–∞–∏–±–æ–ª—å—à–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è)
2. –ü—Ä–æ–≤–µ—Ä—å –Ω–∞ EU 26 –∞–ª–ª–µ—Ä–≥–µ–Ω–æ–≤
3. –û—Ü–µ–Ω–∏ –∫–∞–º–µ–¥–æ–≥–µ–Ω–Ω–æ—Å—Ç—å –ø–æ —à–∫–∞–ª–µ 0-5
4. –£—á–∏—Ç—ã–≤–∞–π –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ç–∏–ø–∞ –∫–æ–∂–∏
5. –£–ø–æ–º—è–Ω–∏ —Ç–æ–ª—å–∫–æ —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
6. –ë—É–¥—å –∫—Ä–∞—Ç–æ–∫, –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–µ–Ω

## –ö–û–†–û–¢–ö–ò–ô –°–ü–ò–°–û–ö –ß–ê–°–¢–´–• –ü–†–û–ë–õ–ï–ú:
‚Ä¢ –ö–æ–Ω—Å–µ—Ä–≤–∞–Ω—Ç—ã: Methylisothiazolinone, Formaldehyde
‚Ä¢ –û—Ç–¥—É—à–∫–∏: Linalool, Limonene, Fragrance
‚Ä¢ –ú–∞—Å–ª–∞: Coconut Oil (–∫–∞–º–µ–¥–æ–≥–µ–Ω–Ω–æ—Å—Ç—å 4), Cocoa Butter
‚Ä¢ –°–ø–∏—Ä—Ç—ã: Denatured Alcohol, Ethanol (—Å—É—à–∞—Ç –∫–æ–∂—É)
‚Ä¢ –ü–ê–í—ã: SLS, SLES (–∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ)`

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ—Å—Ç–∞–≤–∞
export function cleanIngredients(ingredientText) {
    if (!ingredientText) return ''
    
    // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è
    return ingredientText
        .split(/[,;\n]/)
        .map(ing => {
            // –£–±–∏—Ä–∞–µ–º –Ω–æ–º–µ—Ä–∞, —Å–∏–º–≤–æ–ª—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
            return ing
                .replace(/[0-9\.%¬Æ¬©‚Ñ¢]/g, '')
                .replace(/\(.*?\)/g, '') // –£–¥–∞–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ —Å–∫–æ–±–∫–∞—Ö
                .trim()
        })
        .filter(ing => {
            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ
            return ing.length > 2 && 
                   /[a-zA-Z]/.test(ing) && // –ï—Å—Ç—å –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã
                   !/–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç|ingredient|—Å–æ—Å—Ç–∞–≤|–∫–æ–º–ø–æ–Ω–µ–Ω—Ç/i.test(ing) // –ù–µ –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        })
        .slice(0, 30) // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 30 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (—Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ)
        .join(', ')
}

export async function askDeepSeek(typeOf, features, message) {
    try {
        // –û—á–∏—â–∞–µ–º –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
        const cleanedIngredients = cleanIngredients(message)
        
        if (cleanedIngredients.length < 10) {
            throw new Error('–°–æ—Å—Ç–∞–≤ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∏–ª–∏ –Ω–µ—á–∏—Ç–∞–µ–º—ã–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç.')
        }
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–º–ø—Ç
        const systemPrompt = getSystemPrompt(typeOf, features)
        
        const response = await axios.post(
            'https://api.deepseek.com/chat/completions',
            {
                model: 'deepseek-chat',
                messages: [
                    {
                        role: 'system',
                        content: systemPrompt
                    },
                    {
                        role: 'user',
                        content: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç —Å–æ—Å—Ç–∞–≤ –∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å—Ä–µ–¥—Å—Ç–≤–∞:\n\n${cleanedIngredients}\n\n–î–∞–π –ö–†–ê–¢–ö–ò–ô –∞–Ω–∞–ª–∏–∑ (–Ω–µ –±–æ–ª–µ–µ 3500 —Å–∏–º–≤–æ–ª–æ–≤). –ù–∞—á–Ω–∏ —Å —Å–∞–º–æ–≥–æ –≤–∞–∂–Ω–æ–≥–æ - –ø–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ —ç—Ç–æ —Å—Ä–µ–¥—Å—Ç–≤–æ –¥–ª—è ${typeOf} –∫–æ–∂–∏ —Å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è–º–∏: ${features}.`
                    }
                ],
                max_tokens: 1500, // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –æ—Ç–≤–µ—Ç–∞
                temperature: 0.7,
                stream: false
            },
            {
                headers: {
                    'Authorization': `Bearer ${process.env.DEEPSEEK_API_KEY}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                timeout: 30000 // 30 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
            }
        )
        
        if (!response.data?.choices?.[0]?.message?.content) {
            throw new Error('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç API')
        }
        
        // –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç (—É–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã)
        let analysis = response.data.choices[0].message.content.trim()
        
        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π
        if (analysis.length > 3800) {
            analysis = analysis.substring(0, 3800) + '...\n\n‚ö†Ô∏è –û—Ç–≤–µ—Ç –±—ã–ª —Å–æ–∫—Ä–∞—â–µ–Ω –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π Telegram.'
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        if (!analysis.includes('–ö–û–°–ú–ï–¢–ò–ß–ï–°–ö–û–ï –°–†–ï–î–°–¢–í–û:')) {
            analysis = `–ö–û–°–ú–ï–¢–ò–ß–ï–°–ö–û–ï –°–†–ï–î–°–¢–í–û: (–Ω–µ —É–∫–∞–∑–∞–Ω–æ)\n\n` + analysis
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Å—Ç–∞–≤–µ
        analysis += `\n\n---\nüìù *–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:* ${cleanedIngredients.split(',').length}`
        
        return analysis
        
    } catch (error) {
        console.error('DeepSeek API Error:', {
            message: error.message,
            status: error.response?.status,
            data: error.response?.data
        })
        
        // –ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –æ—à–∏–±–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (error.code === 'ECONNABORTED') {
            throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ (30 —Å–µ–∫). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Å–æ—Å—Ç–∞–≤ –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–∑–∂–µ.')
        }
        
        if (error.response?.status === 401) {
            throw new Error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–∏—Å—É –∞–Ω–∞–ª–∏–∑–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–æ–±—â–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.')
        }
        
        if (error.response?.status === 429) {
            throw new Error('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ 1-2 –º–∏–Ω—É—Ç—ã –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.')
        }
        
        if (error.message.includes('–°–æ—Å—Ç–∞–≤ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π')) {
            throw error
        }
        
        if (error.response?.status === 400) {
            throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Å–æ—Å—Ç–∞–≤–∞.')
        }
        
        throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ: ${error.message}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ —É–ø—Ä–æ—Å—Ç–∏—Ç–µ —Å–æ—Å—Ç–∞–≤.`)
    }
}

