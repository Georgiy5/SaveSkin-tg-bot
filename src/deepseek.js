import axios from "axios"

const getSystemPrompt = (typeOf, features, retinoids) => `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ—Å–º–µ—Ç–æ–ª–æ–≥-–¥–µ—Ä–º–∞—Ç–æ–ª–æ–≥. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ—Å—Ç–∞–≤ –∫–æ—Å–º–µ—Ç–∏–∫–∏ —Å —É—á–µ—Ç–æ–º —Ç–µ–∫—É—â–µ–≥–æ —É—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–î–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
–¢–∏–ø –∫–æ–∂–∏: ${typeOf}

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: ${features}

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ—Ç–∏–Ω–æ–∏–¥—ã (—Ä–µ—Ç–∏–Ω–∞–ª—å/—Ä–µ—Ç–∏–Ω–æ–ª/—Ä–µ—Ç–∏–Ω–æ–∏–¥—ã –ø–æ —Ä–µ—Ü–µ–ø—Ç—É): ${retinoids}

–ö–†–ê–¢–ö–ò–ô –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (–º–∞–∫—Å–∏–º—É–º 3500 —Å–∏–º–≤–æ–ª–æ–≤):
–ö–û–°–ú–ï–¢–ò–ß–ï–°–ö–û–ï –°–†–ï–î–°–¢–í–û: [–ù–∞–∑–≤–∞–Ω–∏–µ]

üìä –û–ë–©–ê–Ø –û–¶–ï–ù–ö–ê: X/10
‚ö†Ô∏è –û–°–ù–û–í–ù–´–ï –†–ò–°–ö–ò: [2-3 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö —Ä–∏—Å–∫–∞ —Å —É—á–µ—Ç–æ–º —Ç–∏–ø–∞ –∫–æ–∂–∏. –ï—Å–ª–∏ usesRetinoids=–î–∞, –¥–æ–±–∞–≤–∏—Ç—å —Ä–∏—Å–∫–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∫–æ–º–±–∏–Ω–∞—Ü–∏–µ–π.]

üî¥ –í–´–°–û–ö–û–†–ò–°–ö–û–í–ê–ù–ù–´–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´:
‚Ä¢ [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç 1] - –∫–∞–º–µ–¥–æ–≥–µ–Ω–Ω–æ—Å—Ç—å X/5, –∞–ª–ª–µ—Ä–≥–µ–Ω–Ω–æ—Å—Ç—å: [–≤—ã—Å–æ–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/–Ω–∏–∑–∫–∞—è]. [–ï—Å–ª–∏ usesRetinoids=–î–∞, –ø–æ—è—Å–Ω–∏—Ç—å, –∫–∞–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –Ω–∏–º–∏].
‚Ä¢ [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç 2] - [–∫—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ]

üü° –£–ú–ï–†–ï–ù–ù–û –†–ò–°–ö–û–í–ê–ù–ù–´–ï:
‚Ä¢ [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç] - [–ø–æ—á–µ–º—É –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ]. [–ï—Å–ª–∏ usesRetinoids=–î–∞, —É–ø–æ–º—è–Ω—É—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏—è].

üü¢ –ë–ï–ó–û–ü–ê–°–ù–´–ï/–ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´:
‚Ä¢ [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç] - [–ø–æ–ª—å–∑–∞]. [–ï—Å–ª–∏ usesRetinoids=–î–∞, –≤—ã–¥–µ–ª–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, —É–∫—Ä–µ–ø–ª—è—é—â–∏–µ –±–∞—Ä—å–µ—Ä –∏ —É—Å–ø–æ–∫–∞–∏–≤–∞—é—â–∏–µ].

{{#if (usesRetinoids="–î–∞")}}
üî¨ –ê–ù–ê–õ–ò–ó –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò –° –†–ï–¢–ò–ù–û–ò–î–ê–ú–ò:
‚Ä¢ –ü–æ—Ç–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏—è: [–£–∫–∞–∑–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —á—Ä–µ–∑–º–µ—Ä–Ω–æ —Å—É—à–∏—Ç—å, –æ—Ç—à–µ–ª—É—à–∏–≤–∞—Ç—å –∏–ª–∏ –Ω–∞—Ä—É—à–∞—Ç—å –±–∞—Ä—å–µ—Ä (–∫–∏—Å–ª–æ—Ç—ã, –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–ø–∏—Ä—Ç—ã, –≥—Ä—É–±—ã–µ –∞–±—Ä–∞–∑–∏–≤—ã)].
‚Ä¢ –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ/–î–æ–ø—É—Å—Ç–∏–º—ã–µ: [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç].
‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–µ/–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ: [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥–∞—é—Ç –Ω–∏–≤–µ–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã —Ä–µ—Ç–∏–Ω–æ–∏–¥–æ–≤ (—Ü–µ—Ä–∞–º–∏–¥—ã, –Ω–∏–∞—Ü–∏–Ω–∞–º–∏–¥, –ø–∞–Ω—Ç–µ–Ω–æ–ª, —Å–∫–≤–∞–ª–∞–Ω)].
{{/if}}

üéØ –ü–ï–†–°–û–ù–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:

{{#if (usesRetinoids="–î–∞")}}[–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ä–µ—Ç–∏–Ω–æ–∏–¥–æ–≤] [–°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –Ω–∞–ø—Ä–∏–º–µ—Ä, "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –≤ —É—Ç—Ä–µ–Ω–Ω–µ–π —Ä—É—Ç–∏–Ω–µ/–≤ –¥–Ω–∏ –±–µ–∑ —Ä–µ—Ç–∏–Ω–æ–ª–∞"].{{else}}[–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 1, –æ—Å–Ω–æ–≤–∞–Ω–Ω–∞—è –Ω–∞ —Ç–∏–ø–µ –∫–æ–∂–∏ –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è—Ö].{{/if}}

[–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 2].

[–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è 3].

üß™ –ü–∞—Ç—á-—Ç–µ—Å—Ç: –û—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–µ–Ω –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ä–µ—Ç–∏–Ω–æ–∏–¥–æ–≤ –∏–ª–∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–∂–µ. –ù–∞–Ω–µ—Å–∏—Ç–µ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —á–∞—Å—Ç—å –ø—Ä–µ–¥–ø–ª–µ—á—å—è –∏–ª–∏ –∑–∞ —É—Ö–æ–º –Ω–∞ 24-48 —á–∞—Å–æ–≤.

üìå –í–ï–†–î–ò–ö–¢: [–ü–æ–¥—Ö–æ–¥–∏—Ç/–ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç/–ü–æ–¥—Ö–æ–¥–∏—Ç —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é] - [–ö—Ä–∞—Ç–∫–æ–µ –∏—Ç–æ–≥–æ–≤–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ. –ï—Å–ª–∏ usesRetinoids=–î–∞, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑–∞—Ç—å —Å—Ç–µ–ø–µ–Ω—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏].

–ü–†–ê–í–ò–õ–ê –ê–ù–ê–õ–ò–ó–ê:
–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–µ—Ä–≤—ã–µ 10-15 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –æ—Å–æ–±–µ–Ω–Ω–æ —Ç—â–∞—Ç–µ–ª—å–Ω–æ (–Ω–∞–∏–±–æ–ª—å—à–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è).

–ü—Ä–æ–≤–µ—Ä—å –Ω–∞ EU 26 –∞–ª–ª–µ—Ä–≥–µ–Ω–æ–≤.

–û—Ü–µ–Ω–∏ –∫–∞–º–µ–¥–æ–≥–µ–Ω–Ω–æ—Å—Ç—å –ø–æ —à–∫–∞–ª–µ 0-5.

–ï—Å–ª–∏ usesRetinoids=–î–∞, —ç—Ç–æ –∫–ª—é—á–µ–≤–æ–π —Ñ–∞–∫—Ç–æ—Ä. –ö–æ–∂–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –±–æ–ª–µ–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–π, —Å–∫–ª–æ–Ω–Ω–æ–π –∫ —Å—É—Ö–æ—Å—Ç–∏ –∏ –Ω–∞—Ä—É—à–µ–Ω–∏—é –±–∞—Ä—å–µ—Ä–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏. –û—Ü–µ–Ω–∏–≤–∞–π –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ —ç—Ç—É –ø—Ä–∏–∑–º—É.

–ï—Å–ª–∏ usesRetinoids=–î–∞, –æ–±—Ä–∞—Ç–∏ –æ—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞: –≤—ã—Å–æ–∫–∏–µ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ –∫–∏—Å–ª–æ—Ç (AHA/BHA), —Å–∏–ª—å–Ω—ã–µ —Å–ø–∏—Ä—Ç—ã (Alcohol Denat.), —ç—Ñ–∏—Ä–Ω—ã–µ –º–∞—Å–ª–∞, —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –∞–±—Ä–∞–∑–∏–≤—ã. –û—Ü–µ–Ω–∏ –∏—Ö —Ä–∏—Å–∫ –≤ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Å —Ä–µ—Ç–∏–Ω–æ–∏–¥–∞–º–∏.

–ï—Å–ª–∏ usesRetinoids=–î–∞, –≤—ã–¥–µ–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥–∞—é—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞—Ä—å–µ—Ä (—Ü–µ—Ä–∞–º–∏–¥—ã, —Ö–æ–ª–µ—Å—Ç–µ—Ä–∏–Ω, –∂–∏—Ä–Ω—ã–µ –∫–∏—Å–ª–æ—Ç—ã) –∏ —É—Å–ø–æ–∫–æ–∏—Ç—å –∫–æ–∂—É.

–ë—É–¥—å –∫—Ä–∞—Ç–æ–∫, –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–µ–Ω. –£–ø–æ–º—è–Ω–∏ —Ç–æ–ª—å–∫–æ —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã.

–ö–û–†–û–¢–ö–ò–ô –°–ü–ò–°–û–ö –ß–ê–°–¢–´–• –ü–†–û–ë–õ–ï–ú (–î–û–ü–û–õ–ù–ï–ù–û):
‚Ä¢ –ö–æ–Ω—Å–µ—Ä–≤–∞–Ω—Ç—ã: Methylisothiazolinone, Formaldehyde
‚Ä¢ –û—Ç–¥—É—à–∫–∏: Linalool, Limonene, Fragrance (–æ—Å–æ–±–µ–Ω–Ω–æ —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω—ã –ø—Ä–∏ —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–Ω–æ–π –æ—Ç —Ä–µ—Ç–∏–Ω–æ–∏–¥–æ–≤ –∫–æ–∂–µ)
‚Ä¢ –ú–∞—Å–ª–∞: Coconut Oil (–∫–∞–º–µ–¥–æ–≥–µ–Ω–Ω–æ—Å—Ç—å 4), Cocoa Butter
‚Ä¢ –°–ø–∏—Ä—Ç—ã: Denatured Alcohol, Ethanol (—Å—É—à–∞—Ç –∫–æ–∂—É, –ø–æ—Ç–µ–Ω—Ü–∏—Ä—É—é—Ç —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç —Ä–µ—Ç–∏–Ω–æ–∏–¥–æ–≤)
‚Ä¢ –ü–ê–í—ã: SLS, SLES (–∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ, –º–æ–≥—É—Ç —Å–º—ã–≤–∞—Ç—å –ª–∏–ø–∏–¥—ã –±–∞—Ä—å–µ—Ä–∞)
‚Ä¢ –≠–∫—Å—Ñ–æ–ª–∏–∞–Ω—Ç—ã/–ö–∏—Å–ª–æ—Ç—ã: –í—ã—Å–æ–∫–∏–µ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ Glycolic, Salicylic Acid (–º–æ–≥—É—Ç –≤—ã–∑–≤–∞—Ç—å —Å–∏–ª—å–Ω–æ–µ —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ –≤ –æ–¥–Ω–æ–º —Ä–µ–∂–∏–º–µ —Å —Ä–µ—Ç–∏–Ω–æ–∏–¥–∞–º–∏)
‚Ä¢ –ì—Ä—É–±—ã–µ —Å–∫—Ä–∞–±—ã: –ê–±—Ä–∞–∑–∏–≤–Ω—ã–µ —á–∞—Å—Ç–∏—Ü—ã (–º–æ–≥—É—Ç —Ç—Ä–∞–≤–º–∏—Ä–æ–≤–∞—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—É—é –∫–æ–∂—É –Ω–∞ —Ä–µ—Ç–∏–Ω–æ–∏–¥–∞—Ö)`



// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ—Å—Ç–∞–≤–∞
export function cleanIngredients(ingredientText) {
    if (!ingredientText) return ''
    
    // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è
    return ingredientText
        .split(/[,;\n]/)
        .map(ing => {
            // –£–±–∏—Ä–∞–µ–º –Ω–æ–º–µ—Ä–∞, —Å–∏–º–≤–æ–ª—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
            return ing
                .replace(/[0-9\.%¬Æ¬©‚Ñ¢]/g, '')
                .replace(/\(.*?\)/g, '') // –£–¥–∞–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ —Å–∫–æ–±–∫–∞—Ö
                .trim()
        })
        .filter(ing => {
            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ
            return ing.length > 2 && 
                   /[a-zA-Z]/.test(ing) && // –ï—Å—Ç—å –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã
                   !/–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç|ingredient|—Å–æ—Å—Ç–∞–≤|–∫–æ–º–ø–æ–Ω–µ–Ω—Ç/i.test(ing) // –ù–µ –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        })
        .slice(0, 30) // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 30 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (—Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ)
        .join(', ')
}

export async function askDeepSeek(typeOf, features, message, retinoids) {
    try {
        // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
        const cleanedIngredients = cleanIngredients(message)
        
        if (cleanedIngredients.length < 10) {
            throw new Error('–°–æ—Å—Ç–∞–≤ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∏–ª–∏ –Ω–µ—á–∏—Ç–∞–µ–º—ã–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç.')
        }
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–º–ø—Ç
        const systemPrompt = getSystemPrompt(typeOf, features, retinoids)
        
        const response = await axios.post(
            'https://api.deepseek.com/chat/completions',
            {
                model: 'deepseek-chat',
                messages: [
                    {
                        role: 'system',
                        content: systemPrompt
                    },
                    {
                        role: 'user',
                        content: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç —Å–æ—Å—Ç–∞–≤ –∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å—Ä–µ–¥—Å—Ç–≤–∞:\n\n${cleanedIngredients}\n\n–î–∞–π –ö–†–ê–¢–ö–ò–ô –∞–Ω–∞–ª–∏–∑ (–Ω–µ –±–æ–ª–µ–µ 3500 —Å–∏–º–≤–æ–ª–æ–≤). –ù–∞—á–Ω–∏ —Å —Å–∞–º–æ–≥–æ –≤–∞–∂–Ω–æ–≥–æ - –ø–æ–¥—Ö–æ–¥–∏—Ç –ª–∏ —ç—Ç–æ —Å—Ä–µ–¥—Å—Ç–≤–æ –¥–ª—è ${typeOf} –∫–æ–∂–∏ —Å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è–º–∏: ${features}.`
                    }
                ],
                max_tokens: 1500, // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –æ—Ç–≤–µ—Ç–∞
                temperature: 0.7,
                stream: false
            },
            {
                headers: {
                    'Authorization': `Bearer ${process.env.DEEPSEEK_API_KEY}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                timeout: 60000 // 30 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
            }
        )
        
        if (!response.data?.choices?.[0]?.message?.content) {
            throw new Error('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç API')
        }
        
        // –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç (—É–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã)
        let analysis = response.data.choices[0].message.content.trim()
        
        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π
        if (analysis.length > 3800) {
            analysis = analysis.substring(0, 3800) + '...\n\n‚ö†Ô∏è –û—Ç–≤–µ—Ç –±—ã–ª —Å–æ–∫—Ä–∞—â–µ–Ω –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π Telegram.'
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        if (!analysis.includes('–ö–û–°–ú–ï–¢–ò–ß–ï–°–ö–û–ï –°–†–ï–î–°–¢–í–û:')) {
            analysis = `–ö–û–°–ú–ï–¢–ò–ß–ï–°–ö–û–ï –°–†–ï–î–°–¢–í–û: (–Ω–µ —É–∫–∞–∑–∞–Ω–æ)\n\n` + analysis
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Å—Ç–∞–≤–µ
        analysis += `\n\n---\nüìù *–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:* ${cleanedIngredients.split(',').length}`
        
        return analysis
        
    } catch (error) {
        console.error('DeepSeek API Error:', {
            message: error.message,
            status: error.response?.status,
            data: error.response?.data
        })
        
        // –ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ –æ—à–∏–±–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (error.code === 'ECONNABORTED') {
            throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ (30 —Å–µ–∫). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Å–æ—Å—Ç–∞–≤ –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–∑–∂–µ.')
        }
        
        if (error.response?.status === 401) {
            throw new Error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–∏—Å—É –∞–Ω–∞–ª–∏–∑–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–æ–±—â–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.')
        }
        
        if (error.response?.status === 429) {
            throw new Error('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ 1-2 –º–∏–Ω—É—Ç—ã –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.')
        }
        
        if (error.message.includes('–°–æ—Å—Ç–∞–≤ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π')) {
            throw error
        }
        
        if (error.response?.status === 400) {
            throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Å–æ—Å—Ç–∞–≤–∞.')
        }
        
        throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ: ${error.message}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ —É–ø—Ä–æ—Å—Ç–∏—Ç–µ —Å–æ—Å—Ç–∞–≤.`)
    }
}

